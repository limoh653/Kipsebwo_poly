{% extends 'base.html' %}

{% block content %}
<div style="padding: 20px;">
    <h2>Examinations Department</h2>

    <div style="margin-bottom: 25px;">
        <form method="GET" style="display: flex; gap: 10px;">
            <input type="text" name="q" placeholder="Enter Admission Number..." value="{{ query|default:'' }}" 
                   style="padding: 10px; width: 300px; border: 1px solid #ddd; border-radius: 4px;">
            <button type="submit" style="padding: 10px 20px; background: #34495e; color: white; border: none; border-radius: 4px; cursor: pointer;">
                Search Student
            </button>
            {% if query %}
                <a href="{% url 'examinations' %}" style="padding: 10px; color: #7f8c8d; text-decoration: none;">Clear Search</a>
            {% endif %}
        </form>
    </div>

    <div style="background: #f9f9f9; padding: 20px; border-radius: 8px; margin-bottom: 40px; border: 1px solid #ddd;">
        <form method="POST">
            {% csrf_token %}
            <h3 style="margin-top: 0; color: #2c3e50;">
                {% if form.instance.pk %} Edit Marks for {{ form.instance.student.name }} {% else %} Add Student Marks {% endif %}
            </h3>
            
            <div class="form-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                {{ form.as_p }}
                {% if form.instance.pk %}
                    <input type="hidden" name="instance_id" value="{{ form.instance.pk }}">
                {% endif %}
            </div>

            <button type="submit" class="btn btn-add" style="margin-top: 10px; padding: 10px 20px; background: #27ae60; color: white; border: none; border-radius: 4px; cursor: pointer;">
                {% if form.instance.pk %} Update Marks {% else %} Save Marks {% endif %}
            </button>
            {% if form.instance.pk %}
                <a href="{% url 'examinations' %}" style="margin-left: 10px; color: #e74c3c; text-decoration: none;">Cancel Edit</a>
            {% endif %}
        </form>
    </div>

    <hr>

    <h3 style="margin-top: 30px; color: #2c3e50;">
        {% if student %} Results for: {{ student.name }} ({{ student.admission_number }}) {% else %} Recorded Academic Results {% endif %}
    </h3>

    {% regroup exams by student.course as course_list %}

    {% for course in course_list %}
        <div class="course-group" style="margin-bottom: 50px; border: 2px solid #2c3e50; border-radius: 8px; overflow: hidden;">
            <div style="background: #2c3e50; color: white; padding: 12px 20px; font-size: 1.2em; font-weight: bold;">
                COURSE: {{ course.grouper|upper }}
            </div>

            {% regroup course.list by year_of_study as year_list %}
            
            {% for year in year_list %}
                <div class="year-header" style="background: #ecf0f1; padding: 10px 20px; border-bottom: 1px solid #ddd; font-weight: bold; color: #2980b9;">
                    YEAR {{ year.grouper }}
                </div>

                {% regroup year.list by semester as semester_list %}
                
                {% for sem in semester_list %}
                    <div style="padding: 15px 25px;">
                        <h4 style="color: #e67e22; margin: 0 0 10px 0;">Semester {{ sem.grouper }}</h4>
                        
                        <table style="width: 100%; border-collapse: collapse; margin-bottom: 10px; background: white;">
                            <thead>
                                <tr style="background: #f8f9fa; text-align: left; font-size: 0.9em;">
                                    <th style="padding: 10px; border: 1px solid #ddd;">Admission</th>
                                    <th style="padding: 10px; border: 1px solid #ddd;">Student Name</th>
                                    <th style="padding: 10px; border: 1px solid #ddd;">Subject</th>
                                    <th style="padding: 10px; border: 1px solid #ddd; text-align: center;">Marks</th>
                                    <th style="padding: 10px; border: 1px solid #ddd; text-align: center;">Grade</th>
                                    <th style="padding: 10px; border: 1px solid #ddd; text-align: center;">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for e in sem.list %}
                                <tr>
                                    <td style="padding: 10px; border: 1px solid #ddd;">{{ e.student.admission_number }}</td>
                                    <td style="padding: 10px; border: 1px solid #ddd;">{{ e.student.name }}</td>
                                    <td style="padding: 10px; border: 1px solid #ddd;">{{ e.subject_name }}</td>
                                    <td style="padding: 10px; border: 1px solid #ddd; font-weight: bold; text-align: center;">{{ e.marks }}</td>
                                    <td style="padding: 10px; border: 1px solid #ddd; text-align: center;">
                                        {% if e.marks >= 70 %} <span style="color: green; font-weight: bold;">A</span>
                                        {% elif e.marks >= 60 %} <span style="color: blue; font-weight: bold;">B</span>
                                        {% elif e.marks >= 50 %} <span style="color: orange; font-weight: bold;">C</span>
                                        {% elif e.marks >= 40 %} <span style="color: brown; font-weight: bold;">D</span>
                                        {% else %} <span style="color: red; font-weight: bold;">E (Fail)</span> {% endif %}
                                    </td>
                                    <td style="padding: 10px; border: 1px solid #ddd; text-align: center;">
                                        <a href="?edit={{ e.id }}{% if query %}&q={{ query }}{% endif %}" 
                                           style="color: #2980b9; text-decoration: none; margin-right: 10px;">Edit</a>
                                        
                                        <form method="POST" style="display: inline;" onsubmit="return confirm('Are you sure you want to delete this record?');">
                                            {% csrf_token %}
                                            <input type="hidden" name="delete_id" value="{{ e.id }}">
                                            <button type="submit" style="background: none; border: none; color: #e74c3c; cursor: pointer; padding: 0; font-family: inherit;">Delete</button>
                                        </form>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% endfor %}
            {% endfor %}
        </div>
    {% empty %}
        <p style="background: #fff3cd; padding: 15px; border-radius: 5px; color: #856404;">No results found. Type an Admission Number to search or add new marks above.</p>
    {% endfor %}
</div>
{% endblock %}